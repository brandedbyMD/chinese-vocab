<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ä¸­å›½èªå˜èªå¸³</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #252540;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent: #6c63ff;
      --accent-hover: #5a52d9;
      --success: #4ade80;
      --error: #f87171;
      --border: #3a3a5a;
    }

    body {
      font-family: 'Noto Sans JP', 'Noto Sans SC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .stats {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .nav-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: var(--bg-card);
    }

    .nav-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Add Word Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
    }

    .btn-small {
      padding: 12px 16px;
      font-size: 0.875rem;
    }

    /* Word List */
    .word-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .word-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .word-info {
      flex: 1;
    }

    .word-chinese {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .word-pinyin {
      font-size: 0.875rem;
      color: var(--accent);
      margin-bottom: 2px;
    }

    .word-japanese {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .word-delete {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      opacity: 0.6;
      transition: opacity 0.2s, color 0.2s;
    }

    .word-delete:hover {
      opacity: 1;
      color: var(--error);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    /* Import/Export Buttons */
    .data-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .data-buttons .btn {
      flex: 1;
    }

    /* Practice Section */
    .practice-setup {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mode-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-select:hover {
      border-color: var(--accent);
    }

    .mode-select.selected {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .mode-select h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .mode-select p {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .toggle-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .toggle-option span {
      font-size: 0.875rem;
    }

    .toggle-switch {
      width: 50px;
      height: 28px;
      background: var(--border);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(22px);
    }

    /* Quiz Card */
    .quiz-container {
      display: none;
    }

    .quiz-container.active {
      display: block;
    }

    .quiz-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .quiz-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px 24px;
      text-align: center;
      margin-bottom: 24px;
    }

    .quiz-question {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .quiz-hint {
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .quiz-input {
      width: 100%;
      padding: 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1.25rem;
      text-align: center;
      font-family: inherit;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .quiz-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .quiz-input.correct {
      border-color: var(--success);
      background: rgba(74, 222, 128, 0.1);
    }

    .quiz-input.incorrect {
      border-color: var(--error);
      background: rgba(248, 113, 113, 0.1);
    }

    .quiz-feedback {
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }

    .quiz-feedback .correct-answer {
      color: var(--success);
      font-size: 1.125rem;
      margin-bottom: 4px;
    }

    .quiz-feedback .wrong-answer {
      color: var(--error);
      font-size: 0.875rem;
    }

    .quiz-buttons {
      display: flex;
      gap: 12px;
    }

    .quiz-buttons .btn {
      flex: 1;
    }

    /* Results */
    .results {
      text-align: center;
      padding: 40px 20px;
    }

    .results-score {
      font-size: 4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .results-label {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .results-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 32px;
    }

    .results-stat {
      text-align: center;
    }

    .results-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .results-stat-value.correct {
      color: var(--success);
    }

    .results-stat-value.incorrect {
      color: var(--error);
    }

    .results-stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Search */
    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal h2 {
      font-size: 1.25rem;
      margin-bottom: 8px;
    }

    .modal p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .modal-option {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-option:hover {
      border-color: var(--accent);
    }

    .modal-option h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .modal-option p {
      margin-bottom: 0;
      font-size: 0.8rem;
    }

    .modal-cancel {
      width: 100%;
      padding: 12px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .modal-cancel:hover {
      background: var(--bg-card);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.875rem;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--success);
    }

    .toast.error {
      border-color: var(--error);
    }

    /* Hidden file input */
    .hidden-input {
      display: none;
    }

    /* Responsive */
    @media (max-width: 400px) {
      .container {
        padding: 16px;
      }

      .quiz-question {
        font-size: 2rem;
      }

      .nav-btn {
        padding: 10px 12px;
        font-size: 0.8rem;
      }

      .data-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>ä¸­å›½èªå˜èªå¸³</h1>
      <div class="stats">
        <span id="totalWords">0</span> å˜èª
      </div>
    </header>

    <nav class="nav">
      <button class="nav-btn active" data-section="add">è¿½åŠ </button>
      <button class="nav-btn" data-section="list">å˜èªä¸€è¦§</button>
      <button class="nav-btn" data-section="practice">ç·´ç¿’</button>
    </nav>

    <!-- Add Word Section -->
    <section id="add" class="section active">
      <form id="addWordForm">
        <div class="form-group">
          <label for="chinese">ä¸­å›½èªï¼ˆæ¼¢å­—ï¼‰</label>
          <input type="text" id="chinese" placeholder="ä¾‹ï¼šä½ å¥½" required>
        </div>
        <div class="form-group">
          <label for="pinyin">ãƒ”ãƒ³ã‚¤ãƒ³</label>
          <input type="text" id="pinyin" placeholder="ä¾‹ï¼šnÇ hÇo" required>
        </div>
        <div class="form-group">
          <label for="japanese">æ—¥æœ¬èªè¨³</label>
          <input type="text" id="japanese" placeholder="ä¾‹ï¼šã“ã‚“ã«ã¡ã¯" required>
        </div>
        <button type="submit" class="btn">å˜èªã‚’è¿½åŠ </button>
      </form>
    </section>

    <!-- Word List Section -->
    <section id="list" class="section">
      <div class="data-buttons">
        <button id="exportBtn" class="btn btn-secondary btn-small">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importBtn" class="btn btn-secondary btn-small">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢...">
      </div>
      <div id="wordList" class="word-list"></div>
      <input type="file" id="fileInput" class="hidden-input" accept=".json">
    </section>

    <!-- Practice Section -->
    <section id="practice" class="section">
      <div id="practiceSetup" class="practice-setup">
        <div class="mode-select selected" data-mode="hanzi-pinyin">
          <h3>æ¼¢å­— â†’ ãƒ”ãƒ³ã‚¤ãƒ³</h3>
          <p>æ¼¢å­—ã‚’è¦‹ã¦ãƒ”ãƒ³ã‚¤ãƒ³ã‚’å…¥åŠ›</p>
        </div>
        <div class="mode-select" data-mode="japanese-pinyin">
          <h3>æ—¥æœ¬èª â†’ ãƒ”ãƒ³ã‚¤ãƒ³</h3>
          <p>æ—¥æœ¬èªè¨³ã‚’è¦‹ã¦ãƒ”ãƒ³ã‚¤ãƒ³ã‚’å…¥åŠ›</p>
        </div>
        <div class="mode-select" data-mode="japanese-hanzi">
          <h3>æ—¥æœ¬èª â†’ æ¼¢å­—</h3>
          <p>æ—¥æœ¬èªè¨³ã‚’è¦‹ã¦æ¼¢å­—ã‚’å…¥åŠ›</p>
        </div>
        
        <div class="toggle-option" id="showHintToggle">
          <span>æ—¥æœ¬èªè¨³ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º</span>
          <div class="toggle-switch active"></div>
        </div>

        <button id="startPractice" class="btn">ç·´ç¿’ã‚’é–‹å§‹</button>
      </div>

      <div id="quizContainer" class="quiz-container">
        <div class="quiz-progress">
          <span id="quizProgress">1 / 10</span>
          <span id="quizScore">æ­£è§£: 0</span>
        </div>
        
        <div class="quiz-card">
          <div id="quizQuestion" class="quiz-question">ä½ å¥½</div>
          <div id="quizHint" class="quiz-hint">ã“ã‚“ã«ã¡ã¯</div>
        </div>
        
        <input type="text" id="quizInput" class="quiz-input" placeholder="ç­”ãˆã‚’å…¥åŠ›" autocomplete="off">
        
        <div id="quizFeedback" class="quiz-feedback"></div>
        
        <div class="quiz-buttons">
          <button id="checkAnswer" class="btn">å›ç­”ã™ã‚‹</button>
          <button id="nextQuestion" class="btn" style="display: none;">æ¬¡ã¸</button>
        </div>
        
        <button id="endPractice" class="btn btn-secondary" style="margin-top: 12px;">ç·´ç¿’ã‚’çµ‚äº†</button>
      </div>

      <div id="resultsContainer" class="results" style="display: none;">
        <div class="results-score" id="finalScore">85%</div>
        <div class="results-label">æ­£ç­”ç‡</div>
        <div class="results-stats">
          <div class="results-stat">
            <div class="results-stat-value correct" id="correctCount">8</div>
            <div class="results-stat-label">æ­£è§£</div>
          </div>
          <div class="results-stat">
            <div class="results-stat-value incorrect" id="incorrectCount">2</div>
            <div class="results-stat-label">ä¸æ­£è§£</div>
          </div>
        </div>
        <button id="restartPractice" class="btn">ã‚‚ã†ä¸€åº¦ç·´ç¿’</button>
        <button id="backToSetup" class="btn btn-secondary" style="margin-top: 12px;">è¨­å®šã«æˆ»ã‚‹</button>
      </div>
    </section>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal-overlay">
    <div class="modal">
      <h2>ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–¹æ³•ã‚’é¸æŠ</h2>
      <p>èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«: <span id="importFileName"></span></p>
      
      <div class="modal-option" id="mergeOption">
        <h3>ğŸ”„ ãƒãƒ¼ã‚¸ï¼ˆåˆä½“ï¼‰</h3>
        <p>æ—¢å­˜ã®å˜èªã‚’æ®‹ã—ã¦ã€æ–°ã—ã„å˜èªã‚’è¿½åŠ ã—ã¾ã™</p>
      </div>
      
      <div class="modal-option" id="overwriteOption">
        <h3>ğŸ“ ä¸Šæ›¸ã</h3>
        <p>æ—¢å­˜ã®å˜èªã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã¾ã™</p>
      </div>
      
      <button id="cancelImport" class="modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Data Management
    const DB_KEY = 'chineseVocabDB';
    
    function loadWords() {
      const data = localStorage.getItem(DB_KEY);
      return data ? JSON.parse(data) : [];
    }
    
    function saveWords(words) {
      localStorage.setItem(DB_KEY, JSON.stringify(words));
      updateTotalCount();
    }
    
    function updateTotalCount() {
      document.getElementById('totalWords').textContent = loadWords().length;
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.section).classList.add('active');
        
        if (btn.dataset.section === 'list') {
          renderWordList();
        }
        if (btn.dataset.section === 'practice') {
          resetPractice();
        }
      });
    });

    // Add Word Form
    document.getElementById('addWordForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const chinese = document.getElementById('chinese').value.trim();
      const pinyin = document.getElementById('pinyin').value.trim();
      const japanese = document.getElementById('japanese').value.trim();
      
      if (!chinese || !pinyin || !japanese) return;
      
      const words = loadWords();
      words.push({
        id: Date.now(),
        chinese,
        pinyin,
        japanese,
        correctCount: 0,
        wrongCount: 0,
        lastPracticed: null
      });
      
      saveWords(words);
      
      document.getElementById('chinese').value = '';
      document.getElementById('pinyin').value = '';
      document.getElementById('japanese').value = '';
      document.getElementById('chinese').focus();
      
      showToast('å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    });

    // Word List
    function renderWordList(filter = '') {
      const words = loadWords();
      const container = document.getElementById('wordList');
      
      const filtered = filter 
        ? words.filter(w => 
            w.chinese.includes(filter) || 
            w.pinyin.toLowerCase().includes(filter.toLowerCase()) || 
            w.japanese.includes(filter)
          )
        : words;
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>${filter ? 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“' : 'ã¾ã å˜èªãŒã‚ã‚Šã¾ã›ã‚“'}</p>
            ${!filter ? '<p>ã€Œè¿½åŠ ã€ã‚¿ãƒ–ã‹ã‚‰å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>' : ''}
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(word => `
        <div class="word-item" data-id="${word.id}">
          <div class="word-info">
            <div class="word-chinese">${word.chinese}</div>
            <div class="word-pinyin">${word.pinyin}</div>
            <div class="word-japanese">${word.japanese}</div>
          </div>
          <button class="word-delete" onclick="deleteWord(${word.id})">Ã—</button>
        </div>
      `).join('');
    }

    function deleteWord(id) {
      if (!confirm('ã“ã®å˜èªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      const words = loadWords().filter(w => w.id !== id);
      saveWords(words);
      renderWordList(document.getElementById('searchInput').value);
      showToast('å˜èªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      renderWordList(e.target.value);
    });

    // Export / Import
    document.getElementById('exportBtn').addEventListener('click', () => {
      const words = loadWords();
      
      if (words.length === 0) {
        showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const dataStr = JSON.stringify(words, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().slice(0, 10);
      a.download = `chinese-vocab-${date}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast(`${words.length}ä»¶ã®å˜èªã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    });

    let pendingImportData = null;

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          
          if (!Array.isArray(data)) {
            throw new Error('Invalid format');
          }
          
          // Validate data structure
          const isValid = data.every(item => 
            item.chinese && item.pinyin && item.japanese
          );
          
          if (!isValid) {
            throw new Error('Invalid word format');
          }
          
          pendingImportData = data;
          document.getElementById('importFileName').textContent = file.name;
          document.getElementById('importModal').classList.add('show');
          
        } catch (error) {
          showToast('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™', 'error');
        }
      };
      reader.readAsText(file);
      
      // Reset file input
      e.target.value = '';
    });

    document.getElementById('mergeOption').addEventListener('click', () => {
      if (!pendingImportData) return;
      
      const existingWords = loadWords();
      const existingKeys = new Set(existingWords.map(w => `${w.chinese}-${w.pinyin}-${w.japanese}`));
      
      let addedCount = 0;
      pendingImportData.forEach(word => {
        const key = `${word.chinese}-${word.pinyin}-${word.japanese}`;
        if (!existingKeys.has(key)) {
          existingWords.push({
            ...word,
            id: Date.now() + Math.random(),
            correctCount: word.correctCount || 0,
            wrongCount: word.wrongCount || 0,
            lastPracticed: word.lastPracticed || null
          });
          addedCount++;
        }
      });
      
      saveWords(existingWords);
      closeImportModal();
      renderWordList();
      showToast(`${addedCount}ä»¶ã®æ–°ã—ã„å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    });

    document.getElementById('overwriteOption').addEventListener('click', () => {
      if (!pendingImportData) return;
      
      if (!confirm('æ—¢å­˜ã®å˜èªãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      const newWords = pendingImportData.map(word => ({
        ...word,
        id: Date.now() + Math.random(),
        correctCount: word.correctCount || 0,
        wrongCount: word.wrongCount || 0,
        lastPracticed: word.lastPracticed || null
      }));
      
      saveWords(newWords);
      closeImportModal();
      renderWordList();
      showToast(`${newWords.length}ä»¶ã®å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    });

    document.getElementById('cancelImport').addEventListener('click', closeImportModal);

    document.getElementById('importModal').addEventListener('click', (e) => {
      if (e.target.id === 'importModal') {
        closeImportModal();
      }
    });

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('show');
      pendingImportData = null;
    }

    // Practice Mode
    let currentMode = 'hanzi-pinyin';
    let showHint = true;
    let quizWords = [];
    let currentIndex = 0;
    let correctAnswers = 0;
    let answered = false;

    document.querySelectorAll('.mode-select').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.mode-select').forEach(m => m.classList.remove('selected'));
        el.classList.add('selected');
        currentMode = el.dataset.mode;
        
        // Hide hint toggle for japanese modes
        const hintToggle = document.getElementById('showHintToggle');
        hintToggle.style.display = currentMode === 'hanzi-pinyin' ? 'flex' : 'none';
      });
    });

    document.getElementById('showHintToggle').addEventListener('click', () => {
      showHint = !showHint;
      document.querySelector('#showHintToggle .toggle-switch').classList.toggle('active', showHint);
    });

    function resetPractice() {
      document.getElementById('practiceSetup').style.display = 'flex';
      document.getElementById('quizContainer').classList.remove('active');
      document.getElementById('resultsContainer').style.display = 'none';
      currentIndex = 0;
      correctAnswers = 0;
      quizWords = [];
    }

    function getQuizWords() {
      const words = loadWords();
      if (words.length === 0) return [];
      
      // Sort by priority (more wrong answers = higher priority)
      const sorted = [...words].sort((a, b) => {
        const priorityA = a.wrongCount - a.correctCount;
        const priorityB = b.wrongCount - b.correctCount;
        return priorityB - priorityA;
      });
      
      // Take up to 10 words, shuffled
      const selected = sorted.slice(0, Math.min(10, sorted.length));
      return selected.sort(() => Math.random() - 0.5);
    }

    document.getElementById('startPractice').addEventListener('click', () => {
      quizWords = getQuizWords();
      
      if (quizWords.length === 0) {
        showToast('å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      currentIndex = 0;
      correctAnswers = 0;
      answered = false;
      
      document.getElementById('practiceSetup').style.display = 'none';
      document.getElementById('quizContainer').classList.add('active');
      
      showQuestion();
    });

    function showQuestion() {
      const word = quizWords[currentIndex];
      const questionEl = document.getElementById('quizQuestion');
      const hintEl = document.getElementById('quizHint');
      const inputEl = document.getElementById('quizInput');
      
      // Set question based on mode
      if (currentMode === 'hanzi-pinyin') {
        questionEl.textContent = word.chinese;
        hintEl.textContent = showHint ? word.japanese : '';
        hintEl.style.display = showHint ? 'block' : 'none';
        inputEl.placeholder = 'ãƒ”ãƒ³ã‚¤ãƒ³ã‚’å…¥åŠ›';
      } else if (currentMode === 'japanese-pinyin') {
        questionEl.textContent = word.japanese;
        hintEl.style.display = 'none';
        inputEl.placeholder = 'ãƒ”ãƒ³ã‚¤ãƒ³ã‚’å…¥åŠ›';
      } else if (currentMode === 'japanese-hanzi') {
        questionEl.textContent = word.japanese;
        hintEl.style.display = 'none';
        inputEl.placeholder = 'æ¼¢å­—ã‚’å…¥åŠ›';
      }
      
      document.getElementById('quizProgress').textContent = `${currentIndex + 1} / ${quizWords.length}`;
      document.getElementById('quizScore').textContent = `æ­£è§£: ${correctAnswers}`;
      
      inputEl.value = '';
      inputEl.className = 'quiz-input';
      inputEl.disabled = false;
      inputEl.focus();
      
      document.getElementById('quizFeedback').innerHTML = '';
      document.getElementById('checkAnswer').style.display = 'block';
      document.getElementById('nextQuestion').style.display = 'none';
      
      answered = false;
    }

    function normalizeAnswer(str) {
      return str.toLowerCase()
        .replace(/\s+/g, '')
        .replace(/Ã¼/g, 'v')
        .replace(/\u0304|\u0301|\u030C|\u0300/g, '') // Remove tone marks
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function checkAnswer() {
      if (answered) return;
      
      const word = quizWords[currentIndex];
      const inputEl = document.getElementById('quizInput');
      const userAnswer = inputEl.value.trim();
      
      if (!userAnswer) return;
      
      let correctAnswer;
      if (currentMode === 'japanese-hanzi') {
        correctAnswer = word.chinese;
      } else {
        correctAnswer = word.pinyin;
      }
      
      const isCorrect = currentMode === 'japanese-hanzi'
        ? userAnswer === correctAnswer
        : normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
      
      answered = true;
      inputEl.disabled = true;
      
      // Update word stats
      const words = loadWords();
      const wordIndex = words.findIndex(w => w.id === word.id);
      if (wordIndex !== -1) {
        if (isCorrect) {
          words[wordIndex].correctCount++;
        } else {
          words[wordIndex].wrongCount++;
        }
        words[wordIndex].lastPracticed = Date.now();
        saveWords(words);
      }
      
      if (isCorrect) {
        correctAnswers++;
        inputEl.classList.add('correct');
        document.getElementById('quizFeedback').innerHTML = `
          <div class="correct-answer">æ­£è§£ï¼</div>
        `;
      } else {
        inputEl.classList.add('incorrect');
        document.getElementById('quizFeedback').innerHTML = `
          <div class="correct-answer">æ­£è§£: ${correctAnswer}</div>
          <div class="wrong-answer">ã‚ãªãŸã®å›ç­”: ${userAnswer}</div>
        `;
      }
      
      document.getElementById('quizScore').textContent = `æ­£è§£: ${correctAnswers}`;
      document.getElementById('checkAnswer').style.display = 'none';
      document.getElementById('nextQuestion').style.display = 'block';
      document.getElementById('nextQuestion').focus();
    }

    function nextQuestion() {
      currentIndex++;
      
      if (currentIndex >= quizWords.length) {
        showResults();
      } else {
        showQuestion();
      }
    }

    function showResults() {
      document.getElementById('quizContainer').classList.remove('active');
      document.getElementById('resultsContainer').style.display = 'block';
      
      const percentage = Math.round((correctAnswers / quizWords.length) * 100);
      document.getElementById('finalScore').textContent = `${percentage}%`;
      document.getElementById('correctCount').textContent = correctAnswers;
      document.getElementById('incorrectCount').textContent = quizWords.length - correctAnswers;
    }

    document.getElementById('checkAnswer').addEventListener('click', checkAnswer);
    document.getElementById('nextQuestion').addEventListener('click', nextQuestion);
    
    document.getElementById('quizInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (!answered) {
          checkAnswer();
        } else {
          nextQuestion();
        }
      }
    });

    document.getElementById('endPractice').addEventListener('click', () => {
      if (confirm('ç·´ç¿’ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
        showResults();
      }
    });

    document.getElementById('restartPractice').addEventListener('click', () => {
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('quizContainer').classList.add('active');
      
      quizWords = getQuizWords();
      currentIndex = 0;
      correctAnswers = 0;
      showQuestion();
    });

    document.getElementById('backToSetup').addEventListener('click', resetPractice);

    // Initialize
    updateTotalCount();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
