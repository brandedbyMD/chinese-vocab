<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>‰∏≠ÂõΩË™ûÂçòË™ûÂ∏≥</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #252540;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent: #6c63ff;
      --accent-hover: #5a52d9;
      --success: #4ade80;
      --error: #f87171;
      --border: #3a3a5a;
    }

    body {
      font-family: 'Noto Sans JP', 'Noto Sans SC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 40px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .stats {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .nav-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: var(--bg-card);
    }

    .nav-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Add Word Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input::placeholder, .form-group textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .form-section-title {
      font-size: 0.9rem;
      color: var(--accent);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
    }

    .btn-small {
      padding: 12px 16px;
      font-size: 0.875rem;
    }

    /* Category Tags Input */
    .category-input-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      min-height: 50px;
      align-items: center;
    }

    .category-input-wrapper:focus-within {
      border-color: var(--accent);
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--accent);
      border-radius: 20px;
      font-size: 0.8rem;
      color: white;
    }

    .category-tag .remove-tag {
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      opacity: 0.8;
    }

    .category-tag .remove-tag:hover {
      opacity: 1;
    }

    .category-input {
      flex: 1;
      min-width: 100px;
      padding: 6px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: inherit;
    }

    .category-input:focus {
      outline: none;
    }

    .category-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .category-suggestion {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-suggestion:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Word List */
    .word-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .word-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .word-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .word-info {
      flex: 1;
    }

    .word-chinese {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .word-pinyin {
      font-size: 0.875rem;
      color: var(--accent);
      margin-bottom: 2px;
    }

    .word-japanese {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .word-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .word-category-tag {
      padding: 3px 10px;
      background: var(--bg-card);
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .word-example {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 0.875rem;
    }

    .word-example-chinese {
      color: var(--text-primary);
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .word-example-pinyin {
      color: var(--accent);
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .word-example-japanese {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .word-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .speak-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      opacity: 0.8;
      transition: opacity 0.2s, transform 0.2s;
    }

    .speak-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .speak-btn.small {
      font-size: 1rem;
      padding: 4px;
    }

    .word-delete {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      opacity: 0.6;
      transition: opacity 0.2s, color 0.2s;
    }

    .word-delete:hover {
      opacity: 1;
      color: var(--error);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    /* Import/Export Buttons */
    .data-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .data-buttons .btn {
      flex: 1;
    }

    /* Filter by Category */
    .filter-section {
      margin-bottom: 20px;
    }

    .filter-section label {
      display: block;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .filter-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-category {
      padding: 8px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-category:hover {
      border-color: var(--accent);
    }

    .filter-category.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Practice Section */
    .practice-setup {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mode-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-select:hover {
      border-color: var(--accent);
    }

    .mode-select.selected {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .mode-select h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .mode-select p {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .toggle-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .toggle-option span {
      font-size: 0.875rem;
    }

    .toggle-switch {
      width: 50px;
      height: 28px;
      background: var(--border);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(22px);
    }

    .practice-category-filter {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .practice-category-filter h4 {
      font-size: 0.9rem;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }

    /* Quiz Card */
    .quiz-container {
      display: none;
    }

    .quiz-container.active {
      display: block;
    }

    .quiz-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .quiz-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px 24px;
      text-align: center;
      margin-bottom: 24px;
    }

    .quiz-question-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .quiz-question {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.3;
    }

    .quiz-speak-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--accent);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 12px;
      border-radius: 50%;
      opacity: 0.9;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .quiz-speak-btn:hover {
      opacity: 1;
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .quiz-hint {
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .quiz-input {
      width: 100%;
      padding: 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1.25rem;
      text-align: center;
      font-family: inherit;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .quiz-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .quiz-input.correct {
      border-color: var(--success);
      background: rgba(74, 222, 128, 0.1);
    }

    .quiz-input.incorrect {
      border-color: var(--error);
      background: rgba(248, 113, 113, 0.1);
    }

    /* Handwriting Canvas */
    .handwriting-container {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .handwriting-container.active {
      display: flex;
    }

    .canvas-wrapper {
      position: relative;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .canvas-wrapper.correct {
      border-color: var(--success);
    }

    .canvas-wrapper.incorrect {
      border-color: var(--error);
    }

    #handwritingCanvas {
      display: block;
      width: 100%;
      height: 200px;
      touch-action: none;
    }

    .canvas-controls {
      display: flex;
      gap: 10px;
    }

    .canvas-controls .btn {
      flex: 1;
    }

    .recognized-text {
      text-align: center;
      font-size: 1.5rem;
      color: var(--accent);
      min-height: 40px;
    }

    .quiz-feedback {
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }

    .quiz-feedback .correct-answer {
      color: var(--success);
      font-size: 1.125rem;
      margin-bottom: 4px;
    }

    .quiz-feedback .wrong-answer {
      color: var(--error);
      font-size: 0.875rem;
    }

    .quiz-buttons {
      display: flex;
      gap: 12px;
    }

    .quiz-buttons .btn {
      flex: 1;
    }

    /* Results */
    .results {
      text-align: center;
      padding: 40px 20px;
    }

    .results-score {
      font-size: 4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .results-label {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .results-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 32px;
    }

    .results-stat {
      text-align: center;
    }

    .results-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .results-stat-value.correct {
      color: var(--success);
    }

    .results-stat-value.incorrect {
      color: var(--error);
    }

    .results-stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Search */
    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal h2 {
      font-size: 1.25rem;
      margin-bottom: 8px;
    }

    .modal p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .modal-option {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-option:hover {
      border-color: var(--accent);
    }

    .modal-option h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .modal-option p {
      margin-bottom: 0;
      font-size: 0.8rem;
    }

    .modal-cancel {
      width: 100%;
      padding: 12px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .modal-cancel:hover {
      background: var(--bg-card);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.875rem;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--success);
    }

    .toast.error {
      border-color: var(--error);
    }

    /* Hidden file input */
    .hidden-input {
      display: none;
    }

    /* Responsive */
    @media (max-width: 400px) {
      .container {
        padding: 16px;
      }

      .quiz-question {
        font-size: 2rem;
      }

      .nav-btn {
        padding: 10px 12px;
        font-size: 0.8rem;
      }

      .data-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>‰∏≠ÂõΩË™ûÂçòË™ûÂ∏≥</h1>
      <div class="stats">
        <span id="totalWords">0</span> ÂçòË™û
      </div>
    </header>

    <nav class="nav">
      <button class="nav-btn active" data-section="add">ËøΩÂä†</button>
      <button class="nav-btn" data-section="list">ÂçòË™û‰∏ÄË¶ß</button>
      <button class="nav-btn" data-section="practice">Á∑¥Áøí</button>
    </nav>

    <!-- Add Word Section -->
    <section id="add" class="section active">
      <form id="addWordForm">
        <div class="form-group">
          <label for="chinese">‰∏≠ÂõΩË™ûÔºàÊº¢Â≠óÔºâ*</label>
          <input type="text" id="chinese" placeholder="‰æãÔºö‰Ω†Â•Ω" required>
        </div>
        <div class="form-group">
          <label for="pinyin">„Éî„É≥„Ç§„É≥ *</label>
          <input type="text" id="pinyin" placeholder="‰æãÔºön«ê h«éo" required>
        </div>
        <div class="form-group">
          <label for="japanese">Êó•Êú¨Ë™ûË®≥ *</label>
          <input type="text" id="japanese" placeholder="‰æãÔºö„Åì„Çì„Å´„Å°„ÅØ" required>
        </div>

        <div class="form-group">
          <label>„Ç´„ÉÜ„Ç¥„É™</label>
          <div class="category-input-wrapper" id="categoryInputWrapper">
            <input type="text" class="category-input" id="categoryInput" placeholder="„Ç´„ÉÜ„Ç¥„É™„ÇíÂÖ•Âäõ„Åó„Å¶Enter">
          </div>
          <div class="category-suggestions" id="categorySuggestions"></div>
        </div>

        <div class="form-section-title">‰æãÊñáÔºà‰ªªÊÑèÔºâ</div>
        
        <div class="form-group">
          <label for="exampleChinese">‰æãÊñáÔºà‰∏≠ÂõΩË™ûÔºâ</label>
          <input type="text" id="exampleChinese" placeholder="‰æãÔºö‰Ω†Â•ΩÔºåÊàëÊòØÂ∞èÊòé„ÄÇ">
        </div>
        <div class="form-group">
          <label for="examplePinyin">‰æãÊñá„ÅÆ„Éî„É≥„Ç§„É≥</label>
          <input type="text" id="examplePinyin" placeholder="‰æãÔºöN«ê h«éo, w«í sh√¨ Xi«éo M√≠ng.">
        </div>
        <div class="form-group">
          <label for="exampleJapanese">‰æãÊñá„ÅÆÊó•Êú¨Ë™ûË®≥</label>
          <input type="text" id="exampleJapanese" placeholder="‰æãÔºö„Åì„Çì„Å´„Å°„ÅØ„ÄÅÁßÅ„ÅØÂ∞èÊòé„Åß„Åô„ÄÇ">
        </div>

        <button type="submit" class="btn" style="margin-top: 20px;">ÂçòË™û„ÇíËøΩÂä†</button>
      </form>
    </section>

    <!-- Word List Section -->
    <section id="list" class="section">
      <div class="data-buttons">
        <button id="exportBtn" class="btn btn-secondary btn-small">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        <button id="importBtn" class="btn btn-secondary btn-small">„Ç§„É≥„Éù„Éº„Éà</button>
      </div>

      <div class="filter-section" id="filterSection" style="display: none;">
        <label>„Ç´„ÉÜ„Ç¥„É™„ÅßÁµû„ÇäËæº„Åø</label>
        <div class="filter-categories" id="filterCategories"></div>
      </div>

      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢...">
      </div>
      <div id="wordList" class="word-list"></div>
      <input type="file" id="fileInput" class="hidden-input" accept=".json">
    </section>

    <!-- Practice Section -->
    <section id="practice" class="section">
      <div id="practiceSetup" class="practice-setup">
        <div class="mode-select selected" data-mode="hanzi-pinyin">
          <h3>Êº¢Â≠ó ‚Üí „Éî„É≥„Ç§„É≥</h3>
          <p>Êº¢Â≠ó„ÇíË¶ã„Å¶„Éî„É≥„Ç§„É≥„ÇíÂÖ•Âäõ</p>
        </div>
        <div class="mode-select" data-mode="japanese-pinyin">
          <h3>Êó•Êú¨Ë™û ‚Üí „Éî„É≥„Ç§„É≥</h3>
          <p>Êó•Êú¨Ë™ûË®≥„ÇíË¶ã„Å¶„Éî„É≥„Ç§„É≥„ÇíÂÖ•Âäõ</p>
        </div>
        <div class="mode-select" data-mode="japanese-hanzi">
          <h3>Êó•Êú¨Ë™û ‚Üí Êº¢Â≠óÔºàÊâãÊõ∏„ÅçÔºâ</h3>
          <p>Êó•Êú¨Ë™ûË®≥„ÇíË¶ã„Å¶Êº¢Â≠ó„ÇíÊâãÊõ∏„ÅçÂÖ•Âäõ</p>
        </div>
        
        <div class="toggle-option" id="showHintToggle">
          <span>Êó•Êú¨Ë™ûË®≥„Çí„Éí„É≥„Éà„Å®„Åó„Å¶Ë°®Á§∫</span>
          <div class="toggle-switch active"></div>
        </div>

        <div class="practice-category-filter" id="practiceCategoryFilter" style="display: none;">
          <h4>„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÂèØÔºâ</h4>
          <div class="filter-categories" id="practiceCategories"></div>
        </div>

        <button id="startPractice" class="btn">Á∑¥Áøí„ÇíÈñãÂßã</button>
      </div>

      <div id="quizContainer" class="quiz-container">
        <div class="quiz-progress">
          <span id="quizProgress">1 / 10</span>
          <span id="quizScore">Ê≠£Ëß£: 0</span>
        </div>
        
        <div class="quiz-card">
          <div class="quiz-question-wrapper">
            <div id="quizQuestion" class="quiz-question">‰Ω†Â•Ω</div>
            <button id="quizSpeakBtn" class="quiz-speak-btn" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>
          </div>
          <div id="quizHint" class="quiz-hint">„Åì„Çì„Å´„Å°„ÅØ</div>
        </div>
        
        <input type="text" id="quizInput" class="quiz-input" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ" autocomplete="off">
        
        <div class="handwriting-container" id="handwritingContainer">
          <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="handwritingCanvas"></canvas>
          </div>
          <div class="recognized-text" id="recognizedText"></div>
          <div class="canvas-controls">
            <button id="clearCanvas" class="btn btn-secondary btn-small">Ê∂à„Åô</button>
            <button id="recognizeBtn" class="btn btn-small">Ë™çË≠ò„Åô„Çã</button>
          </div>
        </div>
        
        <div id="quizFeedback" class="quiz-feedback"></div>
        
        <div class="quiz-buttons">
          <button id="checkAnswer" class="btn">ÂõûÁ≠î„Åô„Çã</button>
          <button id="nextQuestion" class="btn" style="display: none;">Ê¨°„Å∏</button>
        </div>
        
        <button id="endPractice" class="btn btn-secondary" style="margin-top: 12px;">Á∑¥Áøí„ÇíÁµÇ‰∫Ü</button>
      </div>

      <div id="resultsContainer" class="results" style="display: none;">
        <div class="results-score" id="finalScore">85%</div>
        <div class="results-label">Ê≠£Á≠îÁéá</div>
        <div class="results-stats">
          <div class="results-stat">
            <div class="results-stat-value correct" id="correctCount">8</div>
            <div class="results-stat-label">Ê≠£Ëß£</div>
          </div>
          <div class="results-stat">
            <div class="results-stat-value incorrect" id="incorrectCount">2</div>
            <div class="results-stat-label">‰∏çÊ≠£Ëß£</div>
          </div>
        </div>
        <button id="restartPractice" class="btn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á∑¥Áøí</button>
        <button id="backToSetup" class="btn btn-secondary" style="margin-top: 12px;">Ë®≠ÂÆö„Å´Êàª„Çã</button>
      </div>
    </section>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal-overlay">
    <div class="modal">
      <h2>„Ç§„É≥„Éù„Éº„ÉàÊñπÊ≥ï„ÇíÈÅ∏Êäû</h2>
      <p>Ë™≠„ÅøËæº„ÇÄ„Éï„Ç°„Ç§„É´: <span id="importFileName"></span></p>
      
      <div class="modal-option" id="mergeOption">
        <h3>üîÑ „Éû„Éº„Ç∏ÔºàÂêà‰ΩìÔºâ</h3>
        <p>Êó¢Â≠ò„ÅÆÂçòË™û„ÇíÊÆã„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑÂçòË™û„ÇíËøΩÂä†„Åó„Åæ„Åô</p>
      </div>
      
      <div class="modal-option" id="overwriteOption">
        <h3>üìù ‰∏äÊõ∏„Åç</h3>
        <p>Êó¢Â≠ò„ÅÆÂçòË™û„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Å¶„ÄÅ„Ç§„É≥„Éù„Éº„Éà„Åó„Åü„Éá„Éº„Çø„Å´ÁΩÆ„ÅçÊèõ„Åà„Åæ„Åô</p>
      </div>
      
      <button id="cancelImport" class="modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Data Management
    const DB_KEY = 'chineseVocabDB';
    const CATEGORIES_KEY = 'chineseVocabCategories';
    
    function loadWords() {
      const data = localStorage.getItem(DB_KEY);
      return data ? JSON.parse(data) : [];
    }
    
    function saveWords(words) {
      localStorage.setItem(DB_KEY, JSON.stringify(words));
      updateTotalCount();
      updateAllCategories();
    }

    function loadCategories() {
      const data = localStorage.getItem(CATEGORIES_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveCategories(categories) {
      localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
    }

    function getAllCategories() {
      const words = loadWords();
      const categorySet = new Set();
      words.forEach(w => {
        if (w.categories) {
          w.categories.forEach(c => categorySet.add(c));
        }
      });
      return Array.from(categorySet).sort();
    }

    function updateAllCategories() {
      const categories = getAllCategories();
      saveCategories(categories);
      updateCategorySuggestions();
      updateFilterCategories();
      updatePracticeCategories();
    }
    
    function updateTotalCount() {
      document.getElementById('totalWords').textContent = loadWords().length;
    }

    // Text-to-Speech
    function speakChinese(text) {
      if (!('speechSynthesis' in window)) {
        showToast('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
      }
      
      speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-CN';
      utterance.rate = 0.8;
      
      const voices = speechSynthesis.getVoices();
      const chineseVoice = voices.find(v => v.lang.startsWith('zh'));
      if (chineseVoice) {
        utterance.voice = chineseVoice;
      }
      
      speechSynthesis.speak(utterance);
    }

    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.section).classList.add('active');
        
        if (btn.dataset.section === 'list') {
          renderWordList();
        }
        if (btn.dataset.section === 'practice') {
          resetPractice();
        }
      });
    });

    // Category Input Management
    let selectedCategories = [];

    function updateCategorySuggestions() {
      const allCategories = getAllCategories();
      const suggestionsContainer = document.getElementById('categorySuggestions');
      
      const availableCategories = allCategories.filter(c => !selectedCategories.includes(c));
      
      if (availableCategories.length === 0) {
        suggestionsContainer.innerHTML = '';
        return;
      }

      suggestionsContainer.innerHTML = availableCategories.map(cat => 
        `<div class="category-suggestion" data-category="${cat}">${cat}</div>`
      ).join('');

      suggestionsContainer.querySelectorAll('.category-suggestion').forEach(el => {
        el.addEventListener('click', () => {
          addCategory(el.dataset.category);
        });
      });
    }

    function renderSelectedCategories() {
      const wrapper = document.getElementById('categoryInputWrapper');
      const input = document.getElementById('categoryInput');
      
      wrapper.querySelectorAll('.category-tag').forEach(el => el.remove());
      
      selectedCategories.forEach(cat => {
        const tag = document.createElement('span');
        tag.className = 'category-tag';
        tag.innerHTML = `${cat}<span class="remove-tag" data-category="${cat}">√ó</span>`;
        wrapper.insertBefore(tag, input);
      });

      wrapper.querySelectorAll('.remove-tag').forEach(el => {
        el.addEventListener('click', () => {
          removeCategory(el.dataset.category);
        });
      });

      updateCategorySuggestions();
    }

    function addCategory(category) {
      category = category.trim();
      if (category && !selectedCategories.includes(category)) {
        selectedCategories.push(category);
        renderSelectedCategories();
      }
      document.getElementById('categoryInput').value = '';
    }

    function removeCategory(category) {
      selectedCategories = selectedCategories.filter(c => c !== category);
      renderSelectedCategories();
    }

    document.getElementById('categoryInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addCategory(e.target.value);
      }
    });

    // Add Word Form
    document.getElementById('addWordForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const chinese = document.getElementById('chinese').value.trim();
      const pinyin = document.getElementById('pinyin').value.trim();
      const japanese = document.getElementById('japanese').value.trim();
      const exampleChinese = document.getElementById('exampleChinese').value.trim();
      const examplePinyin = document.getElementById('examplePinyin').value.trim();
      const exampleJapanese = document.getElementById('exampleJapanese').value.trim();
      
      if (!chinese || !pinyin || !japanese) return;
      
      const words = loadWords();
      const newWord = {
        id: Date.now(),
        chinese,
        pinyin,
        japanese,
        categories: [...selectedCategories],
        correctCount: 0,
        wrongCount: 0,
        lastPracticed: null
      };

      if (exampleChinese) {
        newWord.example = {
          chinese: exampleChinese,
          pinyin: examplePinyin,
          japanese: exampleJapanese
        };
      }

      words.push(newWord);
      saveWords(words);
      
      // Reset form
      document.getElementById('chinese').value = '';
      document.getElementById('pinyin').value = '';
      document.getElementById('japanese').value = '';
      document.getElementById('exampleChinese').value = '';
      document.getElementById('examplePinyin').value = '';
      document.getElementById('exampleJapanese').value = '';
      selectedCategories = [];
      renderSelectedCategories();
      document.getElementById('chinese').focus();
      
      showToast('ÂçòË™û„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
    });

    // Filter categories for word list
    let activeFilterCategories = [];

    function updateFilterCategories() {
      const allCategories = getAllCategories();
      const filterSection = document.getElementById('filterSection');
      const container = document.getElementById('filterCategories');

      if (allCategories.length === 0) {
        filterSection.style.display = 'none';
        return;
      }

      filterSection.style.display = 'block';
      container.innerHTML = `
        <div class="filter-category ${activeFilterCategories.length === 0 ? 'active' : ''}" data-category="__all__">„Åô„Åπ„Å¶</div>
        ${allCategories.map(cat => 
          `<div class="filter-category ${activeFilterCategories.includes(cat) ? 'active' : ''}" data-category="${cat}">${cat}</div>`
        ).join('')}
      `;

      container.querySelectorAll('.filter-category').forEach(el => {
        el.addEventListener('click', () => {
          const category = el.dataset.category;
          if (category === '__all__') {
            activeFilterCategories = [];
          } else {
            if (activeFilterCategories.includes(category)) {
              activeFilterCategories = activeFilterCategories.filter(c => c !== category);
            } else {
              activeFilterCategories.push(category);
            }
          }
          updateFilterCategories();
          renderWordList();
        });
      });
    }

    // Word List
    function renderWordList(filter = '') {
      const words = loadWords();
      const container = document.getElementById('wordList');
      
      let filtered = words;

      // Apply category filter
      if (activeFilterCategories.length > 0) {
        filtered = filtered.filter(w => 
          w.categories && w.categories.some(c => activeFilterCategories.includes(c))
        );
      }

      // Apply text search filter
      if (filter) {
        filtered = filtered.filter(w => 
          w.chinese.includes(filter) || 
          w.pinyin.toLowerCase().includes(filter.toLowerCase()) || 
          w.japanese.includes(filter) ||
          (w.categories && w.categories.some(c => c.includes(filter)))
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>${filter || activeFilterCategories.length > 0 ? 'Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : '„Åæ„Å†ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}</p>
            ${!filter && activeFilterCategories.length === 0 ? '<p>„ÄåËøΩÂä†„Äç„Çø„Éñ„Åã„ÇâÂçòË™û„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>' : ''}
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(word => `
        <div class="word-item" data-id="${word.id}">
          <div class="word-item-header">
            <div class="word-info">
              <div class="word-chinese">${word.chinese}</div>
              <div class="word-pinyin">${word.pinyin}</div>
              <div class="word-japanese">${word.japanese}</div>
              ${word.categories && word.categories.length > 0 ? `
                <div class="word-categories">
                  ${word.categories.map(c => `<span class="word-category-tag">${c}</span>`).join('')}
                </div>
              ` : ''}
            </div>
            <div class="word-actions">
              <button class="speak-btn" onclick="speakChinese('${word.chinese}')" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>
              <button class="word-delete" onclick="deleteWord(${word.id})">√ó</button>
            </div>
          </div>
          ${word.example ? `
            <div class="word-example">
              <div class="word-example-chinese">
                ${word.example.chinese}
                <button class="speak-btn small" onclick="speakChinese('${word.example.chinese}')" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>
              </div>
              ${word.example.pinyin ? `<div class="word-example-pinyin">${word.example.pinyin}</div>` : ''}
              ${word.example.japanese ? `<div class="word-example-japanese">${word.example.japanese}</div>` : ''}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function deleteWord(id) {
      if (!confirm('„Åì„ÅÆÂçòË™û„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      const words = loadWords().filter(w => w.id !== id);
      saveWords(words);
      renderWordList(document.getElementById('searchInput').value);
      showToast('ÂçòË™û„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      renderWordList(e.target.value);
    });

    // Export / Import
    document.getElementById('exportBtn').addEventListener('click', () => {
      const words = loadWords();
      
      if (words.length === 0) {
        showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }
      
      const dataStr = JSON.stringify(words, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().slice(0, 10);
      a.download = `chinese-vocab-${date}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast(`${words.length}‰ª∂„ÅÆÂçòË™û„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
    });

    let pendingImportData = null;

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          
          if (!Array.isArray(data)) {
            throw new Error('Invalid format');
          }
          
          const isValid = data.every(item => 
            item.chinese && item.pinyin && item.japanese
          );
          
          if (!isValid) {
            throw new Error('Invalid word format');
          }
          
          pendingImportData = data;
          document.getElementById('importFileName').textContent = file.name;
          document.getElementById('importModal').classList.add('show');
          
        } catch (error) {
          showToast('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô', 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('mergeOption').addEventListener('click', () => {
      if (!pendingImportData) return;
      
      const existingWords = loadWords();
      const existingKeys = new Set(existingWords.map(w => `${w.chinese}-${w.pinyin}-${w.japanese}`));
      
      let addedCount = 0;
      pendingImportData.forEach(word => {
        const key = `${word.chinese}-${word.pinyin}-${word.japanese}`;
        if (!existingKeys.has(key)) {
          existingWords.push({
            ...word,
            id: Date.now() + Math.random(),
            categories: word.categories || [],
            correctCount: word.correctCount || 0,
            wrongCount: word.wrongCount || 0,
            lastPracticed: word.lastPracticed || null
          });
          addedCount++;
        }
      });
      
      saveWords(existingWords);
      closeImportModal();
      renderWordList();
      showToast(`${addedCount}‰ª∂„ÅÆÊñ∞„Åó„ÅÑÂçòË™û„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
    });

    document.getElementById('overwriteOption').addEventListener('click', () => {
      if (!pendingImportData) return;
      
      if (!confirm('Êó¢Â≠ò„ÅÆÂçòË™û„Åå„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
        return;
      }
      
      const newWords = pendingImportData.map(word => ({
        ...word,
        id: Date.now() + Math.random(),
        categories: word.categories || [],
        correctCount: word.correctCount || 0,
        wrongCount: word.wrongCount || 0,
        lastPracticed: word.lastPracticed || null
      }));
      
      saveWords(newWords);
      closeImportModal();
      renderWordList();
      showToast(`${newWords.length}‰ª∂„ÅÆÂçòË™û„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
    });

    document.getElementById('cancelImport').addEventListener('click', closeImportModal);

    document.getElementById('importModal').addEventListener('click', (e) => {
      if (e.target.id === 'importModal') {
        closeImportModal();
      }
    });

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('show');
      pendingImportData = null;
    }

    // Practice Mode
    let currentMode = 'hanzi-pinyin';
    let showHint = true;
    let quizWords = [];
    let currentIndex = 0;
    let correctAnswers = 0;
    let answered = false;
    let practiceSelectedCategories = [];

    function updatePracticeCategories() {
      const allCategories = getAllCategories();
      const filterDiv = document.getElementById('practiceCategoryFilter');
      const container = document.getElementById('practiceCategories');

      if (allCategories.length === 0) {
        filterDiv.style.display = 'none';
        return;
      }

      filterDiv.style.display = 'block';
      container.innerHTML = `
        <div class="filter-category ${practiceSelectedCategories.length === 0 ? 'active' : ''}" data-category="__all__">„Åô„Åπ„Å¶</div>
        ${allCategories.map(cat => 
          `<div class="filter-category ${practiceSelectedCategories.includes(cat) ? 'active' : ''}" data-category="${cat}">${cat}</div>`
        ).join('')}
      `;

      container.querySelectorAll('.filter-category').forEach(el => {
        el.addEventListener('click', () => {
          const category = el.dataset.category;
          if (category === '__all__') {
            practiceSelectedCategories = [];
          } else {
            if (practiceSelectedCategories.includes(category)) {
              practiceSelectedCategories = practiceSelectedCategories.filter(c => c !== category);
            } else {
              practiceSelectedCategories.push(category);
            }
          }
          updatePracticeCategories();
        });
      });
    }

    document.querySelectorAll('.mode-select').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.mode-select').forEach(m => m.classList.remove('selected'));
        el.classList.add('selected');
        currentMode = el.dataset.mode;
        
        const hintToggle = document.getElementById('showHintToggle');
        hintToggle.style.display = currentMode === 'hanzi-pinyin' ? 'flex' : 'none';
      });
    });

    document.getElementById('showHintToggle').addEventListener('click', () => {
      showHint = !showHint;
      document.querySelector('#showHintToggle .toggle-switch').classList.toggle('active', showHint);
    });

    function resetPractice() {
      document.getElementById('practiceSetup').style.display = 'flex';
      document.getElementById('quizContainer').classList.remove('active');
      document.getElementById('resultsContainer').style.display = 'none';
      currentIndex = 0;
      correctAnswers = 0;
      quizWords = [];
      updatePracticeCategories();
    }

    function getQuizWords() {
      let words = loadWords();

      // Filter by category if selected
      if (practiceSelectedCategories.length > 0) {
        words = words.filter(w => 
          w.categories && w.categories.some(c => practiceSelectedCategories.includes(c))
        );
      }

      if (words.length === 0) return [];
      
      const sorted = [...words].sort((a, b) => {
        const priorityA = a.wrongCount - a.correctCount;
        const priorityB = b.wrongCount - b.correctCount;
        return priorityB - priorityA;
      });
      
      const selected = sorted.slice(0, Math.min(10, sorted.length));
      return selected.sort(() => Math.random() - 0.5);
    }

    document.getElementById('startPractice').addEventListener('click', () => {
      quizWords = getQuizWords();
      
      if (quizWords.length === 0) {
        showToast('Á∑¥Áøí„Åô„ÇãÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }
      
      currentIndex = 0;
      correctAnswers = 0;
      answered = false;
      
      document.getElementById('practiceSetup').style.display = 'none';
      document.getElementById('quizContainer').classList.add('active');
      
      showQuestion();
    });

    function showQuestion() {
      const word = quizWords[currentIndex];
      const questionEl = document.getElementById('quizQuestion');
      const hintEl = document.getElementById('quizHint');
      const inputEl = document.getElementById('quizInput');
      const speakBtn = document.getElementById('quizSpeakBtn');
      const handwritingContainer = document.getElementById('handwritingContainer');
      const canvasWrapper = document.getElementById('canvasWrapper');
      
      // Reset states
      inputEl.style.display = 'block';
      handwritingContainer.classList.remove('active');
      canvasWrapper.classList.remove('correct', 'incorrect');
      document.getElementById('recognizedText').textContent = '';
      clearCanvas();
      
      if (currentMode === 'hanzi-pinyin') {
        questionEl.textContent = word.chinese;
        hintEl.textContent = showHint ? word.japanese : '';
        hintEl.style.display = showHint ? 'block' : 'none';
        inputEl.placeholder = '„Éî„É≥„Ç§„É≥„ÇíÂÖ•Âäõ';
        speakBtn.style.display = 'block';
        speakBtn.onclick = () => speakChinese(word.chinese);
      } else if (currentMode === 'japanese-pinyin') {
        questionEl.textContent = word.japanese;
        hintEl.style.display = 'none';
        inputEl.placeholder = '„Éî„É≥„Ç§„É≥„ÇíÂÖ•Âäõ';
        speakBtn.style.display = 'none';
      } else if (currentMode === 'japanese-hanzi') {
        questionEl.textContent = word.japanese;
        hintEl.style.display = 'none';
        inputEl.style.display = 'none';
        handwritingContainer.classList.add('active');
        speakBtn.style.display = 'none';
        initCanvas();
      }
      
      document.getElementById('quizProgress').textContent = `${currentIndex + 1} / ${quizWords.length}`;
      document.getElementById('quizScore').textContent = `Ê≠£Ëß£: ${correctAnswers}`;
      
      inputEl.value = '';
      inputEl.className = 'quiz-input';
      inputEl.disabled = false;
      if (currentMode !== 'japanese-hanzi') {
        inputEl.focus();
      }
      
      document.getElementById('quizFeedback').innerHTML = '';
      document.getElementById('checkAnswer').style.display = 'block';
      document.getElementById('nextQuestion').style.display = 'none';
      
      answered = false;
    }

    // Handwriting Recognition
    let canvas, ctx;
    let isDrawing = false;
    let strokes = [];
    let currentStroke = [];

    function initCanvas() {
      canvas = document.getElementById('handwritingCanvas');
      ctx = canvas.getContext('2d');
      
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = 200;
      
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Remove old listeners
      canvas.onpointerdown = null;
      canvas.onpointermove = null;
      canvas.onpointerup = null;
      canvas.onpointerleave = null;
      
      // Add new listeners
      canvas.onpointerdown = startDrawing;
      canvas.onpointermove = draw;
      canvas.onpointerup = stopDrawing;
      canvas.onpointerleave = stopDrawing;
    }

    function startDrawing(e) {
      isDrawing = true;
      currentStroke = [];
      const pos = getPos(e);
      currentStroke.push(pos);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!isDrawing) return;
      const pos = getPos(e);
      currentStroke.push(pos);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }

    function stopDrawing() {
      if (isDrawing && currentStroke.length > 0) {
        strokes.push([...currentStroke]);
      }
      isDrawing = false;
      currentStroke = [];
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function clearCanvas() {
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      strokes = [];
      currentStroke = [];
      document.getElementById('recognizedText').textContent = '';
    }

    document.getElementById('clearCanvas').addEventListener('click', clearCanvas);

    document.getElementById('recognizeBtn').addEventListener('click', async () => {
      if (strokes.length === 0) {
        showToast('ÊñáÂ≠ó„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }
      
      try {
        const result = await recognizeHandwriting(strokes, canvas.width, canvas.height);
        if (result && result.length > 0) {
          document.getElementById('recognizedText').textContent = result[0];
        } else {
          document.getElementById('recognizedText').textContent = 'Ë™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
        }
      } catch (error) {
        console.error('Recognition error:', error);
        document.getElementById('recognizedText').textContent = 'Ë™çË≠ò„Ç®„É©„Éº';
      }
    });

    async function recognizeHandwriting(strokes, width, height) {
      // Format strokes for Google API
      const formattedStrokes = strokes.map(stroke => {
        return [
          stroke.map(p => Math.round(p.x)),
          stroke.map(p => Math.round(p.y)),
          stroke.map((_, i) => i * 10)
        ];
      });

      const data = {
        options: 'enable_pre_space',
        requests: [{
          writing_guide: {
            writing_area_width: width,
            writing_area_height: height
          },
          ink: formattedStrokes,
          language: 'zh'
        }]
      };

      const response = await fetch('https://inputtools.google.com/request?itc=zh-t-i0-handwrit&app=translate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      
      if (result[0] === 'SUCCESS' && result[1] && result[1][0] && result[1][0][1]) {
        return result[1][0][1];
      }
      
      return [];
    }

    function normalizeAnswer(str) {
      return str.toLowerCase()
        .replace(/\s+/g, '')
        .replace(/√º/g, 'v')
        .replace(/\u0304|\u0301|\u030C|\u0300/g, '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function checkAnswer() {
      if (answered) return;
      
      const word = quizWords[currentIndex];
      let userAnswer;
      
      if (currentMode === 'japanese-hanzi') {
        userAnswer = document.getElementById('recognizedText').textContent.trim();
        if (!userAnswer || userAnswer === 'Ë™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü' || userAnswer === 'Ë™çË≠ò„Ç®„É©„Éº') {
          showToast('„Åæ„Åö„ÄåË™çË≠ò„Åô„Çã„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
          return;
        }
      } else {
        userAnswer = document.getElementById('quizInput').value.trim();
        if (!userAnswer) return;
      }
      
      let correctAnswer;
      let isCorrect;
      
      if (currentMode === 'japanese-hanzi') {
        correctAnswer = word.chinese;
        isCorrect = userAnswer === correctAnswer;
      } else {
        correctAnswer = word.pinyin;
        isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
      }
      
      answered = true;
      
      const inputEl = document.getElementById('quizInput');
      const canvasWrapper = document.getElementById('canvasWrapper');
      
      if (currentMode !== 'japanese-hanzi') {
        inputEl.disabled = true;
      }
      
      // Update word stats
      const words = loadWords();
      const wordIndex = words.findIndex(w => w.id === word.id);
      if (wordIndex !== -1) {
        if (isCorrect) {
          words[wordIndex].correctCount++;
        } else {
          words[wordIndex].wrongCount++;
        }
        words[wordIndex].lastPracticed = Date.now();
        saveWords(words);
      }
      
      if (isCorrect) {
        correctAnswers++;
        if (currentMode === 'japanese-hanzi') {
          canvasWrapper.classList.add('correct');
        } else {
          inputEl.classList.add('correct');
        }
        document.getElementById('quizFeedback').innerHTML = `
          <div class="correct-answer">Ê≠£Ëß£ÔºÅ</div>
        `;
      } else {
        if (currentMode === 'japanese-hanzi') {
          canvasWrapper.classList.add('incorrect');
        } else {
          inputEl.classList.add('incorrect');
        }
        document.getElementById('quizFeedback').innerHTML = `
          <div class="correct-answer">Ê≠£Ëß£: ${correctAnswer}</div>
          <div class="wrong-answer">„ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î: ${userAnswer}</div>
        `;
      }
      
      document.getElementById('quizScore').textContent = `Ê≠£Ëß£: ${correctAnswers}`;
      document.getElementById('checkAnswer').style.display = 'none';
      document.getElementById('nextQuestion').style.display = 'block';
      document.getElementById('nextQuestion').focus();
    }

    function nextQuestion() {
      currentIndex++;
      
      if (currentIndex >= quizWords.length) {
        showResults();
      } else {
        showQuestion();
      }
    }

    function showResults() {
      document.getElementById('quizContainer').classList.remove('active');
      document.getElementById('resultsContainer').style.display = 'block';
      
      const percentage = Math.round((correctAnswers / quizWords.length) * 100);
      document.getElementById('finalScore').textContent = `${percentage}%`;
      document.getElementById('correctCount').textContent = correctAnswers;
      document.getElementById('incorrectCount').textContent = quizWords.length - correctAnswers;
    }

    document.getElementById('checkAnswer').addEventListener('click', checkAnswer);
    document.getElementById('nextQuestion').addEventListener('click', nextQuestion);
    
    document.getElementById('quizInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (!answered) {
          checkAnswer();
        } else {
          nextQuestion();
        }
      }
    });

    document.getElementById('endPractice').addEventListener('click', () => {
      if (confirm('Á∑¥Áøí„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü')) {
        showResults();
      }
    });

    document.getElementById('restartPractice').addEventListener('click', () => {
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('quizContainer').classList.add('active');
      
      quizWords = getQuizWords();
      currentIndex = 0;
      correctAnswers = 0;
      showQuestion();
    });

    document.getElementById('backToSetup').addEventListener('click', resetPractice);

    // Initialize
    updateTotalCount();
    updateAllCategories();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
